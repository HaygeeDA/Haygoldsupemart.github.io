<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haygold Supermart Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f8fafc;
            /* Slate 50 */
            --card: #ffffff;
            --text: #0f172a;
            /* Slate 900 */
            --text-light: #64748b;
            /* Slate 500 */
            --primary: #3b82f6;
            /* Blue 500 */
            --primary-hover: #2563eb;
            /* Blue 600 */
            --success: #10b981;
            /* Emerald 500 */
            --danger: #ef4444;
            /* Red 500 */
            --warning: #f59e0b;
            /* Amber 500 */
            --border: #e2e8f0;
            /* Slate 200 */
            --sidebar: #1e293b;
            /* Slate 800 */
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--sidebar);
            color: #f1f5f9;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .sidebar h2 {
            margin-bottom: 40px;
            color: #ffffff;
            text-transform: uppercase;
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-align: center;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            background: transparent;
            border: none;
            color: #94a3b8;
            /* Slate 400 */
            padding: 14px 20px;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 12px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #f8fafc;
            transform: translateX(5px);
        }

        .nav-item.active {
            font-weight: 700;
            border: 2px solid var(--sidebar-active-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .user-panel {
            margin-top: auto;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-name {
            font-weight: 800;
            color: #fff;
            display: block;
            font-size: 1.1rem;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #9ca3af;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* MAIN */
        .main {
            flex: 1;
            padding: 30px 40px;
            overflow-y: auto;
            background: var(--bg);
        }

        .page-section {
            display: none;
            animation: fadeIn 0.4s ease;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        /* UI ELEMENTS */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            gap: 8px;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-word {
            background: #2b579a;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        input,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #f8fafc;
            outline: none;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: var(--text);
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        input:disabled {
            background: #e5e7eb;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
        }

        th {
            text-align: left;
            padding: 18px 20px;
            background: #f1f5f9;
            color: var(--text-light);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        th:first-child {
            border-top-left-radius: 12px;
        }

        th:last-child {
            border-top-right-radius: 12px;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #f8fafc;
        }

        .row-high {
            background-color: #ecfdf5 !important;
            color: #065f46;
            font-weight: 600;
        }

        .row-low {
            background-color: #fef2f2 !important;
            color: #991b1b;
        }

        .pay-input {
            width: 100%;
            padding: 5px;
            background: transparent;
            border: 1px solid transparent;
            font-family: inherit;
            font-size: inherit;
        }

        .pay-input:hover,
        .pay-input:focus {
            background: #fff;
            border: 1px solid var(--primary);
        }

        /* POS LAYOUT */
        .pos-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            height: 100%;
        }

        .receipt-box {
            background: white;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            border-radius: 16px;
            overflow: hidden;
        }

        .receipt-header {
            background: #1f2937;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .receipt-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #e5e7eb;
            padding: 10px 0;
        }

        /* DASHBOARD */
        .pnl-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .pnl-net {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--success);
            border-top: 3px double #374151;
            margin-top: 15px;
            padding-top: 15px;
        }

        /* MODAL */
        /* MODAL */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            /* Slate 900 with opacity */
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 999;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: white;
            padding: 40px;
            border-radius: 24px;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* PRINT STYLES */
        @media print {
            body * {
                visibility: hidden;
            }

            .printable,
            .printable * {
                visibility: visible;
            }

            .printable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .no-print,
            .cart-controls,
            button,
            input,
            select {
                display: none !important;
            }

            .pay-input {
                border: none;
                padding: 0;
                background: transparent;
            }

            .receipt-box {
                border: none;
                box-shadow: none;
            }

            .receipt-item {
                font-size: 12px;
            }
        }

        /* MOBILE RESPONSIVENESS */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100%;
                transition: left 0.3s ease;
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
            }

            .sidebar.active {
                left: 0;
            }

            .main {
                padding: 20px 15px;
                margin-top: 50px;
                /* Space for the menu button */
            }

            .pos-layout {
                grid-template-columns: 1fr;
            }

            .mobile-menu-btn {
                display: block !important;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 100;
                background: var(--primary);
                color: white;
                border: none;
                padding: 10px 14px;
                border-radius: 8px;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                font-size: 1.2rem;
            }

            .overlay-sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9;
                backdrop-filter: blur(2px);
            }

            .overlay-sidebar.active {
                display: block;
            }

            /* Adjust tables for mobile */
            .card {
                overflow-x: auto;
                padding: 20px 15px;
            }

            /* Adjust modal width */
            .modal {
                width: 90% !important;
                margin: 10px;
                padding: 20px;
            }

            /* Stack inputs in forms */
            .card>div[style*="display:flex"] {
                flex-direction: column;
                align-items: stretch !important;
            }

            .card>div[style*="display:flex"]>input,
            .card>div[style*="display:flex"]>select,
            .card>div[style*="display:flex"]>button {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Specific fix for POS search and table */
            #pos-search {
                width: 100%;
            }

            h1 {
                font-size: 1.5rem;
            }

            /* INVENTORY CARD VIEW */
            #inv-table,
            #inv-table thead,
            #inv-table tbody,
            #inv-table th,
            #inv-table td,
            #inv-table tr {
                display: block;
            }

            #inv-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            #inv-table tr {
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                margin-bottom: 15px;
                padding: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            #inv-table td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
                padding-top: 5px;
                padding-bottom: 5px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #inv-table td::before {
                content: attr(data-label);
                font-weight: 700;
                color: var(--text-light);
                text-transform: uppercase;
                font-size: 0.75rem;
                text-align: left;
            }

            #inv-table td input {
                width: 60%;
                text-align: right;
            }

            #inv-table td:last-child {
                justify-content: flex-end;
                gap: 10px;
                margin-top: 10px;
                border-top: 1px dashed #e2e8f0;
                padding-top: 15px;
            }
        }

        .mobile-menu-btn {
            display: none;
        }
    </style>
</head>

<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
    <div class="overlay-sidebar" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <h2 id="app-title">Haygold Supermart</h2>

        <button class="nav-item active" onclick="nav('page-inventory', this)"><i class="fa-solid fa-box-open"></i>
            Inventory</button>
        <button class="nav-item" onclick="nav('page-expenses', this)"><i class="fa-solid fa-money-bill-wave"></i>
            Expenses</button>
        <button class="nav-item" onclick="nav('page-accounts', this)"><i class="fa-solid fa-file-invoice-dollar"></i>
            Accounts</button>
        <div style="height:1px; background:rgba(255,255,255,0.1); margin: 10px 0;"></div>
        <button class="nav-item" onclick="nav('page-sales', this)"><i class="fa-solid fa-cart-shopping"></i> Sales
            Point</button>
        <button class="nav-item" onclick="nav('page-analysis', this)"><i class="fa-solid fa-chart-pie"></i> Sales
            Analysis</button>
        <button class="nav-item" onclick="adminNav('page-payroll', this)"><i class="fa-solid fa-users"></i> Payroll <i
                class="fa-solid fa-lock" style="font-size:0.7rem; margin-left:auto;"></i></button>
        <button class="nav-item" onclick="adminNav('page-dashboard', this)"><i class="fa-solid fa-gauge-high"></i>
            Dashboard <i class="fa-solid fa-lock" style="font-size:0.7rem; margin-left:auto;"></i></button>

        <div class="user-panel">
            <span class="user-name" id="user-display">Guest</span>
            <span class="user-role">Logged in</span>
            <div class="action-buttons">
                <button class="action-btn" onclick="openSuperAdmin()">Settings</button>
                <button class="action-btn" onclick="downloadBackup()">Backup</button>
                <button class="action-btn" style="color: #f87171;" onclick="logout()">Logout</button>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
            </div>
            <button class="action-btn" style="width:100%; margin-top:5px; font-size:0.7rem;"
                onclick="document.getElementById('restoreFile').click()">Restore Data</button>
        </div>
    </div>

    <div class="main">
        <!-- INVENTORY -->
        <div id="page-inventory" class="page-section active">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h1>Inventory</h1>
                <button class="btn btn-primary" onclick="openLogModal()">ðŸ“œ Audit Log</button>
            </div>
            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <div style="margin-bottom:15px;"><button class="btn btn-success" onclick="addItem()">+ New
                        Product</button></div>
                <div style="overflow-y:auto;">
                    <table id="inv-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EXPENSES (FIXED) -->
        <div id="page-expenses" class="page-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h1>Expenses</h1>
                <div style="display:flex; gap:10px;">
                    <input type="date" id="exp-date-filter" onchange="renderExp()">
                    <select id="exp-filter" onchange="renderExp()">
                        <option value="all">All Types</option>
                        <option value="one-time">Daily</option>
                        <option value="monthly">Monthly</option>
                        <option value="annually">Annual</option>
                    </select>
                    <button class="btn btn-primary" onclick="printDiv('exp-printable')">Print List</button>
                </div>
            </div>
            <div class="card">
                <h3>Add New Expense</h3>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="exName" placeholder="Description" style="flex:2">
                    <input type="number" id="exCost" placeholder="Cost (â‚¦)" style="flex:1">
                    <select id="exType" style="flex:1">
                        <option value="one-time">Daily</option>
                        <option value="monthly">Monthly</option>
                        <option value="annually">Annually</option>
                    </select>
                    <button class="btn btn-success" onclick="addExpense()">Add</button>
                </div>
            </div>
            <div class="card" id="exp-printable" style="flex:1; overflow-y:auto;">
                <table id="exp-table">
                    <thead>
                        <tr>
                            <th>Desc</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Cost</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ACCOUNTS (UPDATED) -->
        <div id="page-accounts" class="page-section">
            <h1>Accounts</h1>

            <!-- Balances -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="card" style="background:#ecfdf5; border-color:#10b981;">
                    <h3 style="color:#065f46">Receivables (Incoming)</h3>
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <span>Pending: <b id="rec-pending">â‚¦0</b></span>
                        <span>Paid: <b id="rec-paid">â‚¦0</b></span>
                    </div>
                </div>
                <div class="card" style="background:#fef2f2; border-color:#ef4444;">
                    <h3 style="color:#991b1b">Payables (Outgoing)</h3>
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <span>Pending: <b id="pay-pending">â‚¦0</b></span>
                        <span>Paid: <b id="pay-paid">â‚¦0</b></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="accType">
                        <option value="Receivable">Customer Owes Me</option>
                        <option value="Payable">I Owe Supplier</option>
                    </select>
                    <input type="text" id="accName" placeholder="Name">
                    <input type="number" id="accAmt" placeholder="Amount">
                    <input type="date" id="accDate">
                    <button class="btn btn-primary" onclick="addAccount()">Save</button>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <input type="date" id="acc-date-filter" onchange="renderAcc()">
                    <button class="btn btn-word" onclick="printDiv('acc-print')">Print Ledger</button>
                </div>
            </div>
            <div class="card" style="flex:1; overflow-y:auto;" id="acc-print">
                <table id="acc-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th class="no-print-col">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- SALES POINT -->
        <div id="page-sales" class="page-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h1>Sales Point</h1>
                <div>
                    <button class="btn btn-danger" onclick="openRefundModal()">Manage Transactions / Refund</button>
                    <button class="btn btn-primary" onclick="openSalesRepo()">Daily Sales</button>
                </div>
            </div>
            <div class="pos-layout">
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <input type="text" id="pos-search" class="search-input" placeholder="Scan Barcode or Search..."
                        onkeyup="renderPOS(this.value)">
                    <div class="card" style="flex:1; overflow-y:auto; padding:0;">
                        <table id="pos-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Stock</th>
                                    <th>Price</th>
                                    <th>Add</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="receipt-box" id="receipt-printable">
                    <div style="background:#1f2937; color:white; padding:15px; text-align:center;">
                        <h3 id="rec-title" style="margin:0">SUPERMART</h3><small id="rec-date">--</small>
                    </div>
                    <div class="receipt-body" id="cart-items">
                        <p style="text-align:center;color:#999; margin-top:50px;">Cart Empty</p>
                    </div>
                    <div style="background:#f9fafb; padding:15px; border-top:1px solid #ddd;">
                        <div style="display:flex; justify-content:space-between; font-size:1.4rem; font-weight:800;">
                            <span>Total:</span><span id="cart-total">â‚¦0</span>
                        </div>
                        <div id="print-info"
                            style="display:none; font-size:0.9rem; border-top:1px dashed #ccc; margin-top:10px; padding-top:5px;">
                            <div class="pnl-row"><span>Method:</span><span id="print-method"></span></div>
                            <div class="pnl-row"><span>Paid:</span><span id="print-cash"></span></div>
                            <div class="pnl-row" style="font-weight:bold;"><span>Change:</span><span
                                    id="print-change"></span></div>
                            <div style="text-align:center; margin-top:10px;">Thanks for your patronage!</div>
                        </div>
                        <div class="no-print" style="display:grid; gap:5px; margin-top:15px;">
                            <button class="btn btn-success" style="justify-content:center; padding:15px;"
                                onclick="showCheckout()">CHECKOUT</button>
                            <button class="btn btn-danger" style="justify-content:center" onclick="clearCart()">CLEAR
                                CART</button>
                            <button class="btn btn-word" style="justify-content:center"
                                onclick="exportWord('receipt-printable','Voucher')">Download Voucher (Doc)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAYROLL -->
        <div id="page-payroll" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>Payroll Account (Admin)</h1>
                <button class="btn btn-primary" onclick="openPayrollLogs()">ðŸ“œ History</button>
            </div>
            <div class="card" style="display:flex; gap:10px; align-items:center;">
                <label>Period:</label>
                <select id="pay-month" onchange="renderPayroll()">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
                <select id="pay-year" onchange="renderPayroll()">
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            <div class="card">
                <h3>Add Staff</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="st-name" placeholder="Name" style="flex:2">
                    <input type="text" id="st-role" placeholder="Role" style="flex:1">
                    <input type="number" id="st-pay" placeholder="Base Salary" style="flex:1">
                    <button class="btn btn-success" onclick="addStaff()">Add</button>
                </div>
            </div>
            <div class="card" id="payroll-printable" style="flex:1; overflow-y:auto;">
                <div style="text-align:center; margin-bottom:15px;">
                    <h3 id="pay-sheet-header" class="store-name-ph">PAYROLL SHEET</h3>
                    <p id="pay-sheet-period">Period: --</p>
                </div>
                <table id="pay-table">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Role</th>
                            <th>Base Salary</th>
                            <th width="12%">Bonus</th>
                            <th width="12%">Tax</th>
                            <th width="12%">Deduct</th>
                            <th>Net Pay</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="text-align:right; margin-top:10px; font-size:1.2rem; font-weight:bold;">Total Payout: <span
                        id="pay-total">â‚¦0</span></div>
            </div>
            <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-primary" onclick="printDiv('payroll-printable')">Print / PDF</button>
                <button class="btn btn-word" onclick="exportWord('payroll-printable', 'Payroll_Sheet')">Export
                    Doc</button>
            </div>
        </div>

        <!-- SALES ANALYSIS -->
        <div id="page-analysis" class="page-section">
            <h1>Sales Analysis</h1>
            <div class="card" style="display:flex; gap:10px; align-items: center;">
                <button class="btn btn-primary" onclick="analyzeSales('daily')">Today</button>
                <button class="btn btn-primary" onclick="analyzeSales('monthly')">This Month</button>
                <button class="btn btn-primary" onclick="analyzeSales('yearly')">This Year</button>
                <div
                    style="border-left: 1px solid #ccc; padding-left: 10px; display:flex; gap:5px; align-items:center;">
                    <small style="font-weight:bold;">Select Month:</small>
                    <select id="an-month">
                        <option value="0">Jan</option>
                        <option value="1">Feb</option>
                        <option value="2">Mar</option>
                        <option value="3">Apr</option>
                        <option value="4">May</option>
                        <option value="5">Jun</option>
                        <option value="6">Jul</option>
                        <option value="7">Aug</option>
                        <option value="8">Sep</option>
                        <option value="9">Oct</option>
                        <option value="10">Nov</option>
                        <option value="11">Dec</option>
                    </select>
                    <select id="an-year">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                    <button class="btn btn-success" onclick="analyzeSales('custom')">Go</button>
                </div>
            </div>
            <div class="card" id="analysis-printable">
                <h3 id="analysis-title" style="text-align:center; margin-bottom:15px;">Analysis Report</h3>
                <table id="analysis-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Qty Sold</th>
                            <th>Revenue</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p style="margin-top:10px; font-size:0.8rem;">* Green = High Sales, Red = Zero Sales (Dead Stock)</p>
            </div>
            <div style="text-align:right"><button class="btn btn-word"
                    onclick="exportWord('analysis-printable', 'Analysis')">Export</button></div>
        </div>

        <!-- DASHBOARD -->
        <div id="page-dashboard" class="page-section">
            <h1>Dashboard (Locked)</h1>
            <div class="card" style="display:flex; gap:10px; align-items:center;">
                <select id="dash-month" onchange="toggleDashDate()">
                    <option value="live">Today (Live)</option>
                    <option value="date">Specific Date</option>
                    <option value="all">Full Year</option>
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
                <select id="dash-year">
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
                <input type="date" id="dash-date-input" style="display:none;">
                <button class="btn btn-primary" onclick="loadDash()">Load</button>
                <button class="btn btn-primary" onclick="printDiv('pnl-printable')">Print</button>
            </div>
            <div class="card" id="pnl-printable">
                <h3 style="text-align:center; text-decoration:underline;">PROFIT & LOSS</h3>
                <p style="text-align:center; color:#666;" id="pnl-head">Report: Today</p>
                <div class="pnl-row"><span>Revenue</span><span id="pnl-rev" style="color:blue">â‚¦0</span></div>
                <div class="pnl-row"><span>COGS</span><span id="pnl-cogs" style="color:red">(â‚¦0)</span></div>
                <div class="pnl-row" style="font-weight:bold; background:#eee;"><span>GROSS PROFIT</span><span
                        id="pnl-gross">â‚¦0</span></div>
                <div class="pnl-row"><span>Expenses</span><span id="pnl-exp" style="color:red">(â‚¦0)</span></div>
                <div class="pnl-net">
                    <div style="display:flex; justify-content:space-between;"><span id="pnl-label">NET
                            PROFIT</span><span id="pnl-net">â‚¦0</span></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="page-settings" class="page-section">
            <h1>Admin Settings</h1>
            <div class="card">
                <h3>General Settings</h3><label>Supermarket Name:</label><input type="text" id="set-name"
                    placeholder="Enter Store Name"><button class="btn btn-primary" style="margin-top:10px;"
                    onclick="saveSettings()">Save Name</button>
            </div>
            <div class="card">
                <h3>Change Passwords</h3><input type="text" id="set-staff-pass" placeholder="New Staff Password"><input
                    type="text" id="set-admin-pass" placeholder="New Admin Password" style="margin-top:10px;"><button
                    class="btn btn-success" style="margin-top:10px;" onclick="changePasswords()">Update
                    Passwords</button>
            </div>
            <div class="card" style="border-color:red;">
                <h3 style="color:red;">Danger Zone</h3><button class="btn btn-danger" onclick="factoryReset()">FACTORY
                    RESET</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="login-modal" class="overlay" style="display:flex;">
        <div class="modal" style="text-align:center; width:350px;">
            <h2>Login</h2><input type="text" id="login-id" placeholder="Staff Name"
                style="text-align:center; margin-bottom:10px;" onkeyup="if(event.key=='Enter') login()"><input
                type="password" id="login-key" placeholder="Password" style="text-align:center; margin-bottom:20px;"
                onkeyup="if(event.key=='Enter') login()"><button class="btn btn-primary"
                style="width:100%;justify-content:center" onclick="login()">Unlock</button>
        </div>
    </div>
    <div id="super-modal" class="overlay">
        <div class="modal" style="text-align:center; width:350px;">
            <h2>Super Admin</h2><input type="password" id="super-pass" placeholder="Enter Secret Password"
                style="text-align:center;margin-bottom:10px;"><button class="btn btn-primary" style="width:100%;"
                onclick="checkSuper()">Access</button><button class="btn btn-danger" style="width:100%; margin-top:5px;"
                onclick="document.getElementById('super-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="admin-lock-modal" class="overlay">
        <div class="modal" style="text-align:center; width:350px;">
            <h2>Manager Access Required</h2><input type="password" id="admin-lock-pass"
                placeholder="Enter Admin Password" style="text-align:center; margin-bottom:10px;"><button
                class="btn btn-primary" style="width:100%;" onclick="unlockAdminPage()">Verify</button><button
                class="btn btn-danger" style="width:100%; margin-top:5px;"
                onclick="document.getElementById('admin-lock-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="checkout-modal" class="overlay">
        <div class="modal" style="width:350px;">
            <h2>Checkout</h2>
            <h1 style="text-align:right" id="co-total">â‚¦0</h1>
            <label>Method:</label><select id="co-method" style="margin-bottom:10px;">
                <option>Cash</option>
                <option>Card</option>
                <option>Transfer</option>
            </select>
            <label>Tendered:</label><input type="number" id="co-paid" oninput="calcChange()">
            <div style="margin:10px 0; font-weight:bold;">Change: <span id="co-change" style="color:green">â‚¦0</span>
            </div>
            <button class="btn btn-success" style="width:100%" onclick="processSale()">Confirm & Print</button>
            <button class="btn btn-danger" style="width:100%; margin-top:5px;"
                onclick="document.getElementById('checkout-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="restock-modal" class="overlay">
        <div class="modal" style="width:300px;">
            <h3>Restock</h3>
            <h4 id="rs-name"></h4><select id="rs-type" style="margin-bottom:10px;">
                <option value="add">Add Stock</option>
                <option value="reduce">Reduce Stock (Damage/Error)</option>
            </select><input type="number" id="rs-qty" placeholder="Qty"><br><br><button class="btn btn-success"
                onclick="confirmRestock()">Save</button> <button class="btn btn-danger"
                onclick="document.getElementById('restock-modal').style.display='none'">Close</button>
        </div>
    </div>
    <div id="sales-report-modal" class="overlay">
        <div class="modal" style="width:700px;">
            <div style="display:flex; justify-content:space-between;">
                <h3>Daily Sales</h3><button class="btn btn-danger"
                    onclick="document.getElementById('sales-report-modal').style.display='none'">X</button>
            </div>
            <div style="margin:10px 0;"><input type="date" id="rep-date"><button class="btn btn-primary"
                    onclick="genRep()">Generate</button></div>
            <div id="rep-content" style="border:1px solid #ddd; padding:10px; max-height:50vh; overflow:auto;">
                <h3 style="text-align:center" class="store-name-ph">HAYGOLD SALES REPORT</h3>
                <table id="rep-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Items</th>
                            <th>Method</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <h3 style="text-align:right; border-top:2px solid #333;">Total: <span id="rep-total">0</span></h3>
            </div><button class="btn btn-primary" onclick="printDiv('rep-content')">Print</button>
        </div>
    </div>
    <div id="refund-modal" class="overlay">
        <div class="modal" style="width:700px;">
            <h3>Transactions & Refunds</h3>
            <div style="margin-bottom:10px;"><input type="date" id="ref-date" onchange="openRefundModal()"><button
                    class="btn btn-primary" onclick="openRefundModal()">Filter</button></div>
            <div style="max-height:60vh; overflow:auto;">
                <table id="ref-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div><button class="btn btn-danger" style="margin-top:10px;"
                onclick="document.getElementById('refund-modal').style.display='none'">Close</button>
        </div>
    </div>
    <div id="log-modal" class="overlay">
        <div class="modal" style="width:700px;">
            <h3>Audit Logs</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="log-search"
                    placeholder="Search..." onkeyup="renderLogs()"><input type="date" id="log-date"
                    onchange="renderLogs()">
                <button class="btn btn-primary" style="padding: 5px 10px;"
                    onclick="document.getElementById('log-date').valueAsDate = new Date(); renderLogs()">Today</button>
                <button class="btn btn-word" style="padding: 5px 10px;"
                    onclick="document.getElementById('log-date').value=''; renderLogs()">Show All</button>
            </div>
            <div id="log-content" style="max-height:50vh; overflow:auto; border:1px solid #ddd;">
                <table id="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;"><button
                    class="btn btn-primary" onclick="printDiv('log-content')">Print / PDF</button><button
                    class="btn btn-word" onclick="exportWord('log-content', 'Audit_Log')">Export to Word</button><button
                    class="btn btn-danger"
                    onclick="document.getElementById('log-modal').style.display='none'">Close</button></div>
        </div>
    </div>
    <div id="payroll-log-modal" class="overlay">
        <div class="modal" style="width:700px;">
            <h3>Payroll History</h3>
            <div id="pay-log-content" style="max-height:50vh; overflow:auto; border:1px solid #ddd; padding:10px;">
                <table id="pay-log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;"><button
                    class="btn btn-primary" onclick="printDiv('pay-log-content')">Print / PDF</button><button
                    class="btn btn-word" onclick="exportWord('pay-log-content', 'Payroll_History')">Export to
                    Word</button><button class="btn btn-danger"
                    onclick="document.getElementById('payroll-log-modal').style.display='none'">Close</button></div>
        </div>
    </div>

    <script>
        let db = { inventory: [], expenses: [], accounts: [], logs: [], sales: [], history: [], payroll: [], staff: [], today: { date: '', rev: 0, cogs: 0 }, pass: 'anaconda', adminPass: 'latika', user: 'Guest', storeName: 'Haygold Supermart' };
        let pendingPage = null;

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay-sidebar').classList.toggle('active');
        }

        function init() {
            try {
                let s = localStorage.getItem('haygold_final_v90');
                if (s) {
                    db = { ...db, ...JSON.parse(s) };
                    if (!db.sales) db.sales = []; if (!db.history) db.history = []; if (!db.logs) db.logs = []; if (!db.staff) db.staff = []; if (!db.payData) db.payData = []; if (!db.pass) db.pass = "anaconda";
                    if (db.today.date !== new Date().toDateString()) {
                        db.history.push(db.today);
                        db.today = { date: new Date().toDateString(), rev: 0, cogs: 0 };
                        log("System: New day reset");
                        save();
                    }
                } else {
                    db.inventory = [{ id: 1, name: "Sample Item", cost: 1000, price: 1500, stock: 50 }];
                    db.today.date = new Date().toDateString();
                    save();
                }
            } catch (e) { console.error("Data Reset"); db.pass = "anaconda"; save(); }

            let yr = new Date().getFullYear();
            document.getElementById('dash-year').value = yr; document.getElementById('an-year').value = yr; document.getElementById('pay-year').value = yr;
            document.getElementById('an-month').value = new Date().getMonth(); document.getElementById('pay-month').value = new Date().getMonth();
            document.getElementById('accDate').valueAsDate = new Date();

            updateStoreName(); renderInv(); renderExp(); renderAcc(); renderPayroll();

            document.getElementById('pos-search').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    let query = this.value.trim(); if (!query) return;
                    let item = db.inventory.find(i => i.name.toLowerCase().includes(query.toLowerCase()));
                    if (item) {
                        let inCart = cart.filter(c => c.id === item.id).length;
                        if (item.stock > inCart) { cart.push(item); renderCart(); this.value = ''; renderPOS(); }
                        else { alert("Out of Stock!"); this.value = ''; }
                    } else { alert("Item not found!"); this.value = ''; }
                }
            });
        }
        function save() { localStorage.setItem('haygold_final_v90', JSON.stringify(db)); }
        function log(msg) { db.logs.unshift({ time: new Date().toLocaleString(), text: `[${db.user}] ${msg}` }); if (db.logs.length > 500) db.logs.pop(); save(); }
        function updateStoreName() { document.getElementById('app-title').innerText = db.storeName; document.getElementById('rec-title').innerText = db.storeName.toUpperCase(); document.querySelectorAll('.store-name-ph').forEach(e => e.innerText = db.storeName.toUpperCase() + " REPORT"); document.getElementById('set-name').value = db.storeName; document.title = db.storeName; }

        function login() { let u = document.getElementById('login-id').value; let p = document.getElementById('login-key').value; if (u.trim() === "") return alert("Enter Staff Name"); if (!db.pass) { db.pass = 'anaconda'; save(); } if (p === db.pass) { db.user = u; document.getElementById('user-display').innerText = u; document.getElementById('login-modal').style.display = 'none'; document.getElementById('pos-search').focus(); log("Logged in"); loadDash(); } else { alert("Incorrect Password"); } }
        function logout() { db.user = "Guest"; document.getElementById('login-id').value = ''; document.getElementById('login-key').value = ''; document.getElementById('login-modal').style.display = 'flex'; document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active')); }
        function openSuperAdmin() { document.getElementById('super-modal').style.display = 'flex'; document.getElementById('super-pass').value = ''; }
        function checkSuper() { if (document.getElementById('super-pass').value === 'babalatika') { document.getElementById('super-modal').style.display = 'none'; nav('page-settings', document.querySelector('.nav-item')); } else { alert("Access Denied"); } }
        function adminNav(pageId, btn) { pendingPage = { id: pageId, btn: btn }; document.getElementById('admin-lock-modal').style.display = 'flex'; document.getElementById('admin-lock-pass').value = ''; document.getElementById('admin-lock-pass').focus(); }
        function unlockAdminPage() { if (document.getElementById('admin-lock-pass').value === db.adminPass) { document.getElementById('admin-lock-modal').style.display = 'none'; nav(pendingPage.id, pendingPage.btn); } else { alert("Incorrect Admin Password"); } }
        function saveSettings() { db.storeName = document.getElementById('set-name').value; save(); updateStoreName(); alert("Settings Saved!"); }
        function changePasswords() { const ns = document.getElementById('set-staff-pass').value; const na = document.getElementById('set-admin-pass').value; if (ns) db.pass = ns; if (na) db.adminPass = na; save(); alert("Passwords Updated"); }
        function factoryReset() { if (confirm("WARNING: Delete ALL DATA?")) { if (confirm("Really?")) { localStorage.removeItem('haygold_final_v90'); location.reload(); } } }
        function nav(id, btn) { document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); if (btn) { document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } if (window.innerWidth <= 768) { document.querySelector('.sidebar').classList.remove('active'); document.querySelector('.overlay-sidebar').classList.remove('active'); } if (id === 'page-sales') { renderPOS(); document.getElementById('pos-search').focus(); } if (id === 'page-dashboard') loadDash(); if (id === 'page-analysis') analyzeSales('daily'); if (id === 'page-payroll') renderPayroll(); }

        // --- POS LOGIC ---
        let cart = [];
        function renderPOS(s = '') { const tb = document.querySelector('#pos-table tbody'); tb.innerHTML = ''; db.inventory.forEach(i => { if (i.name.toLowerCase().includes(s.toLowerCase())) { tb.innerHTML += `<tr><td>${i.name}</td><td style="color:${i.stock < 5 ? 'red' : 'green'}">${i.stock}</td><td>â‚¦${Number(i.price).toLocaleString()}</td><td><button class="btn btn-success btn-sm" ${i.stock <= 0 ? 'disabled' : ''} onclick="addCart(${i.id})">Add</button></td></tr>`; } }); }
        function addCart(id) { let item = db.inventory.find(x => x.id === id), inC = cart.filter(c => c.id === id).length; if (item.stock > inC) { cart.push(item); renderCart(); } else alert("Out of Stock"); }
        function renderCart() { const box = document.getElementById('cart-items'); if (!cart.length) { box.innerHTML = '<p style="text-align:center;color:#999">Cart Empty</p>'; document.getElementById('cart-total').innerText = 'â‚¦0'; return 0; } let grp = {}, tot = 0, html = ''; cart.forEach(i => { grp[i.id] = grp[i.id] ? { ...i, qty: grp[i.id].qty + 1 } : { ...i, qty: 1 } }); Object.values(grp).forEach(i => { let lt = Number(i.price) * i.qty; tot += lt; html += `<div class="receipt-item"><span>${i.name} x${i.qty}</span><div class="cart-controls" style="display:flex;align-items:center;gap:5px;"><span>â‚¦${lt.toLocaleString()}</span><button class="btn btn-danger btn-sm" onclick="remCart(${i.id})">-</button><button class="btn btn-danger btn-sm" onclick="killCart(${i.id})">x</button></div></div>`; }); box.innerHTML = html; document.getElementById('cart-total').innerText = 'â‚¦' + tot.toLocaleString(); return tot; }
        function remCart(id) { let idx = cart.findIndex(x => x.id === id); if (idx > -1) cart.splice(idx, 1); renderCart(); }
        function killCart(id) { cart = cart.filter(x => x.id !== id); renderCart(); }
        function clearCart() { cart = []; renderCart(); document.getElementById('print-info').style.display = 'none'; }
        function showCheckout() { if (!cart.length) return alert("Cart is empty!"); document.getElementById('co-total').innerText = 'â‚¦' + renderCart().toLocaleString(); document.getElementById('co-paid').value = ''; document.getElementById('checkout-modal').style.display = 'flex'; document.getElementById('co-paid').focus(); }
        function calcChange() { let p = parseFloat(document.getElementById('co-paid').value) || 0; document.getElementById('co-change').innerText = 'â‚¦' + (p - renderCart()).toLocaleString(); }

        function processSale() {
            let tot = renderCart(), paid = parseFloat(document.getElementById('co-paid').value) || 0, meth = document.getElementById('co-method').value;
            if (paid < tot) return alert("Insufficient funds");

            let grp = {}; cart.forEach(i => { grp[i.id] = grp[i.id] ? { ...i, qty: grp[i.id].qty + 1 } : { ...i, qty: 1 } });
            let snap = Object.values(grp).map(l => { let orig = db.inventory.find(x => x.id === l.id); return { id: l.id, name: l.name, qty: l.qty, soldPrice: Number(orig.price), soldCost: Number(orig.cost) }; });
            snap.forEach(l => { let inv = db.inventory.find(x => x.id === l.id); inv.stock -= l.qty; db.today.rev += (l.soldPrice * l.qty); db.today.cogs += (l.soldCost * l.qty); });
            let itemsStr = snap.map(s => `${s.name}(x${s.qty})`).join(', ');
            db.sales.push({ id: Date.now(), date: new Date().toDateString(), time: new Date().toLocaleTimeString(), items: itemsStr, total: tot, method: meth, status: 'Valid', details: snap });
            log(`Sold â‚¦${tot} via ${meth}`); save(); renderInv(); renderPOS(); loadDash();

            document.getElementById('print-method').innerText = meth; document.getElementById('print-cash').innerText = "â‚¦" + paid.toLocaleString(); document.getElementById('print-change').innerText = "â‚¦" + (paid - tot).toLocaleString(); document.getElementById('rec-date').innerText = new Date().toLocaleString();
            document.getElementById('print-info').style.display = 'block'; document.getElementById('checkout-modal').style.display = 'none';

            // AUTO PRINT & CLEAR
            printDiv('receipt-printable');
            setTimeout(() => clearCart(), 1000);
        }

        // --- OTHER FUNCTIONS ---
        function renderPayroll() { let m = parseInt(document.getElementById('pay-month').value), y = parseInt(document.getElementById('pay-year').value), tb = document.querySelector('#pay-table tbody'), tot = 0; tb.innerHTML = ''; db.staff.forEach(s => { let r = db.payData.find(p => p.staffId === s.id && p.month === m && p.year === y); let sal = r ? r.salary : s.baseSalary, b = r ? r.bonus : 0, t = r ? r.tax : 0, d = r ? r.deduct : 0, net = (sal + b) - (t + d); tot += net; tb.innerHTML += `<tr><td><input class="pay-input" value="${s.name}" onchange="updateStaffMaster(${s.id},'name',this.value)"></td><td><input class="pay-input" value="${s.role}" onchange="updateStaffMaster(${s.id},'role',this.value)"></td><td><input type="number" class="pay-input" value="${sal}" onchange="updatePayRecord(${s.id},'salary',this.value)"></td><td><input type="number" class="pay-input" value="${b}" onchange="updatePayRecord(${s.id},'bonus',this.value)"></td><td><input type="number" class="pay-input" value="${t}" onchange="updatePayRecord(${s.id},'tax',this.value)"></td><td><input type="number" class="pay-input" value="${d}" onchange="updatePayRecord(${s.id},'deduct',this.value)"></td><td style="font-weight:bold">â‚¦${net.toLocaleString()}</td><td><button class="btn btn-danger btn-sm" onclick="deleteStaff(${s.id})">x</button></td></tr>`; }); document.getElementById('pay-total').innerText = "â‚¦" + tot.toLocaleString(); document.getElementById('pay-sheet-period').innerText = `Period: ${document.getElementById('pay-month').options[m].text} ${y}`; }
        function addStaff() { let n = document.getElementById('st-name').value, r = document.getElementById('st-role').value, b = parseFloat(document.getElementById('st-pay').value) || 0; if (n && r) { if (!db.staff) db.staff = []; db.staff.push({ id: Date.now(), name: n, role: r, baseSalary: b }); log(`[Payroll] Added ${n}`); save(); renderPayroll(); document.getElementById('st-name').value = ''; } else alert("Fill details"); }
        function updateStaffMaster(id, f, v) { let s = db.staff.find(x => x.id === id); if (s) { s[f] = v; save(); } }
        function updatePayRecord(id, f, v) { let m = parseInt(document.getElementById('pay-month').value), y = parseInt(document.getElementById('pay-year').value), val = parseFloat(v) || 0, r = db.payData.find(p => p.staffId === id && p.month === m && p.year === y); if (!r) { let s = db.staff.find(x => x.id === id); r = { id: Date.now(), staffId: id, month: m, year: y, salary: s.baseSalary, bonus: 0, tax: 0, deduct: 0 }; db.payData.push(r); } r[f] = val; log(`[Payroll] Updated: ${val}`); save(); renderPayroll(); }
        function deleteStaff(id) { if (confirm("Delete?")) { db.staff = db.staff.filter(s => s.id !== id); log("[Payroll] Deleted staff"); save(); renderPayroll(); } }
        function openPayrollLogs() { document.getElementById('payroll-log-modal').style.display = 'flex'; document.querySelector('#pay-log-table tbody').innerHTML = db.logs.filter(l => l.text.includes('Payroll')).map(l => `<tr><td>${l.time}</td><td>${l.text}</td></tr>`).join(''); }
        function renderInv() { const tb = document.querySelector('#inv-table tbody'); tb.innerHTML = ''; db.inventory.forEach((i, x) => { tb.innerHTML += `<tr><td data-label="Item Name"><input value="${i.name}" onchange="updInv(${x},'name',this.value)"></td><td data-label="Cost"><input type="number" value="${i.cost}" onchange="updInv(${x},'cost',this.value)"></td><td data-label="Price"><input type="number" value="${i.price}" onchange="updInv(${x},'price',this.value)"></td><td data-label="Stock"><input type="number" value="${i.stock}" disabled style="background:#eee;font-weight:bold"></td><td data-label="Actions"><button class="btn btn-primary btn-sm" onclick="prepRS(${x})">+</button> <button class="btn btn-danger btn-sm" onclick="delInv(${x})">x</button></td></tr>`; }); }
        function updInv(x, k, v) { db.inventory[x][k] = (k == 'cost' || k == 'price') ? Number(v) : v; log(`Updated ${db.inventory[x].name} ${k}`); save(); }
        function addItem() { db.inventory.push({ id: Date.now(), name: "New", cost: 0, price: 0, stock: 0 }); log("Added Item"); save(); renderInv(); }
        function delInv(x) { if (confirm("Delete?")) { log("Deleted " + db.inventory[x].name); db.inventory.splice(x, 1); save(); renderInv(); } }
        let rIdx = null; function prepRS(x) { rIdx = x; document.getElementById('rs-name').innerText = db.inventory[x].name; document.getElementById('restock-modal').style.display = 'flex'; }
        function confirmRestock() { let q = parseInt(document.getElementById('rs-qty').value), type = document.getElementById('rs-type').value; if (q > 0) { let old = db.inventory[rIdx].stock; if (type === 'add') db.inventory[rIdx].stock += q; else db.inventory[rIdx].stock -= q; log(`Stock ${type} ${db.inventory[rIdx].name}: ${old}->${db.inventory[rIdx].stock}`); save(); renderInv(); document.getElementById('restock-modal').style.display = 'none'; } }
        function renderExp() { let f = document.getElementById('exp-filter').value, d = document.getElementById('exp-date-filter').value, tb = document.querySelector('#exp-table tbody'); tb.innerHTML = ''; db.expenses.forEach((e, x) => { let matchDate = d ? new Date(e.date).toDateString() === new Date(d).toDateString() : true; if ((f == 'all' || e.type == f) && matchDate) tb.innerHTML += `<tr><td>${e.name}</td><td>${e.type}</td><td>${new Date(e.date).toLocaleDateString()}</td><td>â‚¦${e.cost.toLocaleString()}</td><td><button class="btn btn-danger btn-sm" onclick="delExp(${x})">x</button></td></tr>`; }); }
        function addExpense() { let n = document.getElementById('exName').value, c = parseFloat(document.getElementById('exCost').value), t = document.getElementById('exType').value; if (n && c) { db.expenses.push({ name: n, cost: c, type: t, date: new Date().toISOString() }); log(`Added Exp: ${n} â‚¦${c}`); save(); renderExp(); } }
        function delExp(x) { if (confirm("Delete?")) { log("Deleted Exp"); db.expenses.splice(x, 1); save(); renderExp(); } }
        function renderAcc() { let d = document.getElementById('acc-date-filter').value, tb = document.querySelector('#acc-table tbody'); tb.innerHTML = ''; let recP = 0, recPd = 0, payP = 0, payPd = 0; db.accounts.forEach((a, x) => { let matchDate = d ? a.date === d : true; if (matchDate) { let st = a.status == 'Paid' ? 'green' : 'red'; let dateStr = a.date ? new Date(a.date).toLocaleDateString() : '-'; tb.innerHTML += `<tr><td>${a.type}</td><td>${a.name}</td><td>${dateStr}</td><td>â‚¦${a.amount.toLocaleString()}</td><td onclick="togAcc(${x})" style="cursor:pointer;color:${st}">${a.status}</td><td class="no-print-col"><button class="btn btn-danger btn-sm" onclick="delAcc(${x})">x</button></td></tr>`; } if (a.type == 'Receivable') { if (a.status == 'Pending') recP += a.amount; else recPd += a.amount; } else { if (a.status == 'Pending') payP += a.amount; else payPd += a.amount; } }); document.getElementById('rec-pending').innerText = "â‚¦" + recP.toLocaleString(); document.getElementById('rec-paid').innerText = "â‚¦" + recPd.toLocaleString(); document.getElementById('pay-pending').innerText = "â‚¦" + payP.toLocaleString(); document.getElementById('pay-paid').innerText = "â‚¦" + payPd.toLocaleString(); }
        function addAccount() { let t = document.getElementById('accType').value, n = document.getElementById('accName').value, a = parseFloat(document.getElementById('accAmt').value), d = document.getElementById('accDate').value || new Date().toISOString().split('T')[0]; if (n && a) { db.accounts.push({ type: t, name: n, amount: a, date: d, status: 'Pending' }); log("Added Acc"); save(); renderAcc(); } }
        function togAcc(x) { db.accounts[x].status = db.accounts[x].status == 'Paid' ? 'Pending' : 'Paid'; save(); renderAcc(); }
        function delAcc(x) { if (confirm("Delete?")) { db.accounts.splice(x, 1); save(); renderAcc(); } }
        function openLogModal() { renderLogs(); document.getElementById('log-modal').style.display = 'flex'; }
        function renderLogs() { let s = document.getElementById('log-search').value.toLowerCase(), d = document.getElementById('log-date').value, tb = document.querySelector('#log-table tbody'); tb.innerHTML = ''; db.logs.filter(l => { let mt = l.text.toLowerCase().includes(s) || l.time.toLowerCase().includes(s); let md = d ? new Date(l.time).toDateString() === new Date(d + 'T00:00:00').toDateString() : true; return mt && md; }).forEach(l => tb.innerHTML += `<tr><td>${l.time}</td><td>${l.text}</td></tr>`); }
        function openSalesRepo() { document.getElementById('sales-report-modal').style.display = 'flex'; document.getElementById('rep-date').valueAsDate = new Date(); }
        function genRep() { let d = document.getElementById('rep-date').valueAsDate; if (!d) return; let ds = d.toDateString(), tb = document.querySelector('#rep-table tbody'), gt = 0; tb.innerHTML = ''; let recs = db.sales.filter(r => r.date === ds && r.status !== 'Refunded'); if (!recs.length) tb.innerHTML = '<tr><td colspan="4">No Sales</td></tr>'; else recs.forEach(r => { gt += r.total; tb.innerHTML += `<tr><td>${r.time}</td><td>${r.items}</td><td>${r.method}</td><td>â‚¦${r.total.toLocaleString()}</td></tr>`; }); document.getElementById('rep-total').innerText = "â‚¦" + gt.toLocaleString(); }
        function openRefundModal() { document.getElementById('refund-modal').style.display = 'flex'; let d = document.getElementById('ref-date').valueAsDate || new Date(); let ds = d.toDateString(); let tb = document.querySelector('#ref-table tbody'), recs = db.sales.filter(r => r.date === ds && r.status !== 'Refunded'); tb.innerHTML = recs.length ? '' : '<tr><td colspan="4">No Sales</td></tr>'; recs.forEach(r => { tb.innerHTML += `<tr><td>${r.time}</td><td>${r.items}</td><td>â‚¦${r.total}</td><td><button class="btn btn-danger btn-sm" onclick="refund(${r.id})">Refund</button> <button class="btn btn-warning btn-sm" onclick="reprint(${r.id})">ðŸ–¨ï¸</button></td></tr>`; }); }
        function refund(id) { if (confirm("Refund?")) { let r = db.sales.find(x => x.id === id); r.details.forEach(l => { let i = db.inventory.find(x => x.id === l.id); if (i) i.stock += l.qty; db.today.rev -= l.qty * l.soldPrice; db.today.cogs -= l.qty * l.soldCost; }); r.status = 'Refunded'; log(`Refunded #${id}`); save(); renderInv(); loadDash(); document.getElementById('refund-modal').style.display = 'none'; } }
        function reprint(id) { let r = db.sales.find(x => x.id === id); if (!r) return; let h = ''; r.details.forEach(i => { h += `<div class="receipt-item"><span>${i.name} x${i.qty}</span><span>â‚¦${(i.soldPrice * i.qty).toLocaleString()}</span></div>`; }); document.getElementById('cart-items').innerHTML = h; document.getElementById('cart-total').innerText = 'â‚¦' + r.total.toLocaleString(); document.getElementById('print-method').innerText = r.method; document.getElementById('print-cash').innerText = '-'; document.getElementById('print-change').innerText = '-'; document.getElementById('rec-date').innerText = r.date + ' ' + r.time; document.getElementById('print-info').style.display = 'block'; printDiv('receipt-printable'); setTimeout(() => clearCart(), 1000); }
        function analyzeSales(p) { let m = {}; db.inventory.forEach(i => m[i.id] = { name: i.name, qty: 0, rev: 0 }); let now = new Date(); db.sales.forEach(s => { if (s.status == 'Refunded') return; let d = new Date(s.date), match = false; if (p == 'daily') match = d.toDateString() == now.toDateString(); else if (p == 'monthly') match = d.getMonth() == now.getMonth() && d.getFullYear() == now.getFullYear(); else if (p == 'yearly') match = d.getFullYear() == now.getFullYear(); else { let mm = parseInt(document.getElementById('an-month').value), yy = parseInt(document.getElementById('an-year').value); match = d.getMonth() == mm && d.getFullYear() == yy; } if (match && s.details) s.details.forEach(l => { if (m[l.id]) { m[l.id].qty += l.qty; m[l.id].rev += (l.qty * l.soldPrice); } }); }); let res = Object.values(m).sort((a, b) => b.qty - a.qty), tb = document.querySelector('#analysis-table tbody'); tb.innerHTML = ''; let max = res.length ? res[0].qty : 0; res.forEach(i => { let c = i.qty === 0 ? 'row-low' : (i.qty > (max * 0.5) ? 'row-high' : ''); tb.innerHTML += `<tr class="${c}"><td>${i.name}</td><td>${i.qty}</td><td>â‚¦${i.rev.toLocaleString()}</td><td>${i.qty === 0 ? 'Dead' : (i.qty > (max * 0.5) ? 'High' : 'Normal')}</td></tr>`; }); }
        function toggleDashDate() { let v = document.getElementById('dash-month').value; if (v === 'date') { document.getElementById('dash-date-input').style.display = 'block'; document.getElementById('dash-year').style.display = 'none'; } else { document.getElementById('dash-date-input').style.display = 'none'; document.getElementById('dash-year').style.display = 'block'; } }
        function loadDash() {
            let m = document.getElementById('dash-month').value, y = parseInt(document.getElementById('dash-year').value), all = [...db.history, db.today], rev = 0, cogs = 0, selDate = null;
            if (m === 'date') { let dv = document.getElementById('dash-date-input').value; if (!dv) return alert("Select Date"); selDate = new Date(dv).toDateString(); }

            if (m === 'live') { rev = db.today.rev; cogs = db.today.cogs; }
            else if (m === 'date') { let h = all.find(r => new Date(r.date).toDateString() === selDate); if (h) { rev = h.rev; cogs = h.cogs; } if (selDate === new Date().toDateString()) { rev = db.today.rev; cogs = db.today.cogs; } }
            else if (m === 'all') all.forEach(r => { if (new Date(r.date).getFullYear() === y) { rev += r.rev; cogs += r.cogs } });
            else all.forEach(r => { let d = new Date(r.date); if (d.getFullYear() === y && d.getMonth() === parseInt(m)) { rev += r.rev; cogs += r.cogs } });

            let mE = db.expenses.filter(e => e.type == 'monthly').reduce((a, b) => a + b.cost, 0), yE = db.expenses.filter(e => e.type == 'annually').reduce((a, b) => a + b.cost, 0), dE = 0, exp = 0;
            if (m === 'live' || m === 'date') { let td = m === 'live' ? new Date().toDateString() : selDate; dE = db.expenses.filter(e => e.type == 'one-time' && new Date(e.date).toDateString() == td).reduce((a, b) => a + b.cost, 0); exp = (mE / 30) + (yE / 365) + dE; }
            else if (m === 'all') { dE = db.expenses.filter(e => e.type == 'one-time' && new Date(e.date).getFullYear() == y).reduce((a, b) => a + b.cost, 0); exp = (mE * 12) + yE + dE; }
            else { let mi = parseInt(m); dE = db.expenses.filter(e => e.type == 'one-time' && new Date(e.date).getFullYear() == y && new Date(e.date).getMonth() == mi).reduce((a, b) => a + b.cost, 0); exp = mE + (yE / 12) + dE; }

            document.getElementById('pnl-rev').innerText = 'â‚¦' + rev.toLocaleString(); document.getElementById('pnl-cogs').innerText = '(â‚¦' + cogs.toLocaleString() + ')'; document.getElementById('pnl-gross').innerText = 'â‚¦' + (rev - cogs).toLocaleString(); document.getElementById('pnl-exp').innerText = '(â‚¦' + Math.round(exp).toLocaleString() + ')';
            let net = rev - cogs - exp; document.getElementById('pnl-net').innerText = 'â‚¦' + Math.round(net).toLocaleString(); document.getElementById('pnl-label').innerText = net >= 0 ? "NET PROFIT" : "NET LOSS"; document.getElementById('pnl-label').style.color = net >= 0 ? "green" : "red";
            let lbl = "Today"; if (m === 'all') lbl = `Year ${y}`; else if (m === 'date') lbl = selDate; else if (m !== 'live') lbl = `${document.getElementById('dash-month').options[document.getElementById('dash-month').selectedIndex].text} ${y}`; document.getElementById('pnl-head').innerText = `Report: ${lbl}`;
        }
        function printDiv(id) { let c = document.getElementById(id).innerHTML, w = window.open('', '', 'height=600,width=800'); let s = id.includes('receipt') ? 'body{font-family:monospace;width:80mm;margin:0} button,.no-print,.cart-controls{display:none !important} .receipt-item{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px}' : 'table{width:100%;border-collapse:collapse}td,th{border:1px solid #000;padding:5px} .pay-input{border:none} .no-print-col{display:none}'; w.document.write(`<html><head><style>${s}</style></head><body>${c}</body></html>`); w.document.close(); setTimeout(() => w.print(), 500); }
        function exportWord(id, name) { let h = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><style>table{width:100%;border-collapse:collapse}td,th{border:1px solid #000;padding:5px} .no-print-col{display:none}</style></head><body>${document.getElementById(id).innerHTML}</body></html>`, b = new Blob(['\ufeff', h], { type: 'application/msword' }), l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = name + ".doc"; l.click(); }
        function downloadBackup() { let l = document.createElement("a"); l.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); l.download = "haygold_backup.json"; l.click(); }
        function restoreData(i) { let r = new FileReader(); r.onload = e => { try { db = JSON.parse(e.target.result); save(); alert("Restored!"); location.reload(); } catch (x) { alert("Error"); } }; r.readAsText(i.files[0]); }

        init();
    </script>
</body>

</html>
